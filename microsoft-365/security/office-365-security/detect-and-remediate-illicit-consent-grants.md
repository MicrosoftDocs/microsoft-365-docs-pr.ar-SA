---
title: الكشف عن منح الموافقة غير المشروعة ومعالجتها
f1.keywords:
- NOCSH
ms.author: tracyp
author: MSFTTracyp
manager: dansimp
audience: ITPro
ms.topic: article
ms.collection:
- o365_security_incident_response
- M365-security-compliance
ms.date: 07/28/2022
ms.localizationpriority: medium
search.appverid:
- MET150
description: تعرف على كيفية التعرف على الموافقة غير المشروعة التي تمنح الهجوم في Microsoft 365 ومعالجتها.
ms.custom:
- seo-marvel-apr2020
ms.technology: mdo
ms.prod: m365-security
ms.openlocfilehash: 354e32ca01a17be69f0bb144a437fd3e825613ea
ms.sourcegitcommit: 1e53bf8208c30d7b60685896207cc1142bebf34a
ms.translationtype: MT
ms.contentlocale: ar-SA
ms.lasthandoff: 07/28/2022
ms.locfileid: "67059700"
---
# <a name="detect-and-remediate-illicit-consent-grants"></a>الكشف عن منح الموافقة غير المشروعة ومعالجتها

[!INCLUDE [MDO Trial banner](../includes/mdo-trial-banner.md)]

**ينطبق على**
- [خطة 1 وخطة 2 من Microsoft Defender لـ Office 365](defender-for-office-365.md)
- [Microsoft 365 Defender](../defender/microsoft-365-defender.md)

**موجز**  تعرف على كيفية التعرف على الموافقة غير المشروعة التي تمنح الهجوم في Microsoft 365 ومعالجتها.

## <a name="what-is-the-illicit-consent-grant-attack-in-microsoft-365"></a>ما هو هجوم منح الموافقة غير المشروعة في Microsoft 365؟

في هجوم منح الموافقة غير المشروعة، ينشئ المهاجم تطبيقا مسجلا في Azure يطلب الوصول إلى بيانات مثل معلومات الاتصال أو البريد الإلكتروني أو المستندات. ثم يخدع المتطفل المستخدم النهائي لمنح هذا التطبيق الموافقة على الوصول إلى بياناته إما من خلال هجوم تصيد احتيالي، أو عن طريق إدخال تعليمات برمجية غير قانونية في موقع ويب موثوق به. بعد منح التطبيق غير المشروع الموافقة، لديه حق الوصول على مستوى الحساب إلى البيانات دون الحاجة إلى حساب تنظيمي. خطوات المعالجة العادية، مثل إعادة تعيين كلمات المرور للحسابات المخترقة أو طلب المصادقة متعددة العوامل (MFA) على الحسابات، ليست فعالة ضد هذا النوع من الهجوم، نظرا لأنها تطبيقات تابعة لجهة خارجية وخارجية للمؤسسة.

تستفيد هذه الهجمات من نموذج تفاعل يفترض أن الكيان الذي يستدعي المعلومات هو الأتمتة وليس الإنسان.

> [!IMPORTANT]
> هل تشك في أنك تواجه مشاكل في منح الموافقة غير المشروعة من تطبيق، في الوقت الحالي؟ يحتوي Microsoft Defender for Cloud Apps على أدوات للكشف عن تطبيقات OAuth الخاصة بك والتحقيق فيها ومعالجتها. تحتوي مقالة Defender for Cloud Apps هذه على برنامج تعليمي يوضح كيفية [التحقيق في تطبيقات OAuth المحفوفة بالمخاطر](/cloud-app-security/investigate-risky-oauth). يمكنك أيضا تعيين [نهج تطبيق OAuth](/cloud-app-security/app-permission-policy) للتحقيق في الأذونات المطلوبة من قبل التطبيق، والتي يصرح بها المستخدمون لهذه التطبيقات، والموافقة على طلبات الأذونات هذه أو حظرها على نطاق واسع.

## <a name="what-does-an-illicit-consent-grant-attack-look-like-in-microsoft-365"></a>كيف تبدو الموافقة غير المشروعة لمنح الهجوم في Microsoft 365؟

تحتاج إلى البحث في **سجل التدقيق** للعثور على علامات، تسمى أيضا مؤشرات التسوية (IOC) لهذا الهجوم. بالنسبة للمؤسسات التي تحتوي على العديد من التطبيقات المسجلة في Azure وقاعدة مستخدمين كبيرة، فإن أفضل الممارسات هي مراجعة منح موافقة المؤسسات على أساس أسبوعي.

### <a name="steps-for-finding-signs-of-this-attack"></a>خطوات للعثور على علامات هذا الهجوم

1. افتح مدخل Microsoft 365 Defender في <https://security.microsoft.com> ثم حدد **Audit**. أو للانتقال مباشرة إلى صفحة **تدقيق**، استخدم <https://security.microsoft.com/auditlogsearch>.

2. في صفحة **التدقيق** ، تحقق من تحديد علامة التبويب **"بحث** "، ثم قم بتكوين الإعدادات التالية:
   - **نطاق التاريخ والوقت**
   - **الأنشطة**: تحقق من تحديد **إظهار النتائج لكافة الأنشطة** .

   عند الانتهاء، انقر فوق **بحث**.

3. انقر فوق عمود **النشاط** لفرز النتائج وابحث عن **الموافقة على التطبيق**.

4. حدد إدخالا من القائمة للاطلاع على تفاصيل النشاط. تحقق لمعرفة ما إذا تم تعيين IsAdminConsent إلى True.

> [!NOTE]
>
> قد يستغرق عرض إدخال سجل التدقيق المطابق في نتائج البحث بعد وقوع حدث ما من 30 دقيقة إلى 24 ساعة.
>
> يعتمد طول الوقت الذي يتم فيه الاحتفاظ بسجل تدقيق وقابل للبحث فيه في سجل التدقيق على اشتراكك في Microsoft 365، وعلى وجه التحديد نوع الترخيص المعين لمستخدم معين. لمزيد من المعلومات، راجع [سجل التدقيق](../../compliance/search-the-audit-log-in-security-and-compliance.md).
>
> إذا كانت هذه القيمة صحيحة، فإنها تشير إلى أن شخصا لديه حق الوصول إلى المسؤول العام قد منح وصولا واسعا إلى البيانات. إذا كان هذا غير متوقع، فاتخذ خطوات [لتأكيد الهجوم](#how-to-confirm-an-attack).

## <a name="how-to-confirm-an-attack"></a>كيفية تأكيد هجوم

إذا كان لديك مثيل واحد أو أكثر من IOCs المذكورة أعلاه، تحتاج إلى إجراء مزيد من التحقيق لتأكيد وقوع الهجوم بشكل إيجابي. يمكنك استخدام أي من هذه الأساليب الثلاث لتأكيد الهجوم:

- تطبيقات المخزون وأذوناتها باستخدام مدخل Azure Active Directory. هذه الطريقة شاملة، ولكن يمكنك التحقق من مستخدم واحد فقط في كل مرة والتي يمكن أن تستغرق وقتا طويلا جدا إذا كان لديك العديد من المستخدمين للتحقق منها.
- تطبيقات المخزون وأذوناتها باستخدام PowerShell. هذا هو الأسلوب الأسرع والأكثر شمولا، مع أقل قدر من النفقات العامة.
- اطلب من المستخدمين التحقق من تطبيقاتهم وأذوناتهم بشكل فردي والإبلاغ عن النتائج إلى المسؤولين للمعالجة.

## <a name="inventory-apps-with-access-in-your-organization"></a>تطبيقات المخزون ذات الوصول في مؤسستك

يمكنك القيام بذلك للمستخدمين باستخدام مدخل Azure Active Directory أو PowerShell أو أن يقوم المستخدمون بتعداد الوصول إلى التطبيق بشكل فردي.

### <a name="steps-for-using-the-azure-active-directory-portal"></a>خطوات استخدام مدخل Azure Active Directory

يمكنك البحث عن التطبيقات التي منحها أي مستخدم فردي أذونات باستخدام مدخل Azure Active Directory في <https://portal.azure.com>.

1. سجل الدخول إلى مدخل Azure مع حقوق إدارية.
2. حدد جزء Azure Active Directory.
3. حدد **المستخدمون**.
4. حدد المستخدم الذي تريد مراجعته.
5. حدد **التطبيقات**.

سيظهر لك ذلك التطبيقات التي تم تعيينها للمستخدم والأذونات المتوفرة للتطبيقات.

### <a name="steps-for-having-your-users-enumerate-their-application-access"></a>خطوات جعل المستخدمين يعدون الوصول إلى التطبيق الخاص بهم

اطلب من المستخدمين الانتقال إلى <https://myapps.microsoft.com> التطبيق الخاص بهم ومراجعته هناك. يجب أن يكونوا قادرين على رؤية جميع التطبيقات ذات الوصول، وعرض تفاصيل عنها (بما في ذلك نطاق الوصول)، وأن يكونوا قادرين على إبطال الامتيازات للتطبيقات المشبوهة أو غير المشروعة.

### <a name="steps-for-doing-this-with-powershell"></a>خطوات للقيام بذلك باستخدام PowerShell

أبسط طريقة للتحقق من هجوم منح الموافقة غير المشروعة هي تشغيل [Get-AzureADPSPermissions.ps1](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09)، والتي ستتخلص من جميع منح موافقة OAuth وتطبيقات OAuth لجميع المستخدمين في إيجارك في ملف .csv واحد.

#### <a name="pre-requisites"></a>المتطلبات الأساسية

- تم تثبيت مكتبة Azure AD PowerShell.
- مسؤول عمومي الحقوق على المستأجر التي سيتم تشغيل البرنامج النصي مقابلها.
- المسؤول المحلي على الكمبيوتر الذي سيقوم بتشغيل البرامج النصية منه.

> [!IMPORTANT]
> ***نوصي بشدة*** بأن تحتاج إلى مصادقة متعددة العوامل على حسابك الإداري. يدعم هذا البرنامج النصي مصادقة المصادقة متعددة العوامل.

1. سجل الدخول إلى الكمبيوتر الذي ستقوم بتشغيل البرنامج النصي منه مع حقوق المسؤول المحلي.

2. قم بتنزيل البرنامج النصي [Get-AzureADPSPermissions.ps1](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09) أو نسخه من GitHub إلى مجلد ستقوم بتشغيل البرنامج النصي منه. سيكون هذا هو نفس المجلد الذي ستتم كتابة ملف الإخراج "permissions.csv".

3. افتح جلسة عمل PowerShell كمسؤول وافتح المجلد الذي حفظت البرنامج النصي فيه.

4. الاتصال بالدليل باستخدام [Connect-AzureAD](/powershell/module/azuread/connect-azuread) cmdlet.

5. تشغيل أمر PowerShell هذا:

   ```powershell
   .\Get-AzureADPSPermissions.ps1 | Export-csv -Path "Permissions.csv" -NoTypeInformation
   ```

ينتج البرنامج النصي ملفا واحدا يسمى Permissions.csv. اتبع هذه الخطوات للبحث عن منح أذونات التطبيق غير المشروعة:

1. في عمود ConsentType (العمود G) ابحث عن القيمة "AllPrinciples". يسمح إذن AllPrincipals لتطبيق العميل بالوصول إلى محتوى الجميع في الإيجار. تحتاج تطبيقات Microsoft 365 الأصلية إلى هذا الإذن للعمل بشكل صحيح. يجب مراجعة كل تطبيق غير خاص ب Microsoft بهذا الإذن بعناية.

2. في عمود الإذن (العمود F) راجع الأذونات التي يملكها كل تطبيق مفوض للمحتوى. ابحث عن إذن "قراءة" و"كتابة" أو إذن "الكل"، وراجعها بعناية لأنها قد لا تكون مناسبة.

3. راجع المستخدمين المحددين الذين لديهم موافقات تم منحها. إذا منح المستخدمون البارزون أو ذوو التأثير العالي موافقات غير ملائمة، فيجب عليك إجراء مزيد من التحقيق.

4. في العمود ClientDisplayName (العمود C) ابحث عن التطبيقات التي تبدو مريبة. يجب مراجعة التطبيقات ذات الأسماء التي تحتوي على أخطاء إملائية أو أسماء مرتفعة أو أسماء صوت المتسللين بعناية.

## <a name="determine-the-scope-of-the-attack"></a>تحديد نطاق الهجوم

بعد الانتهاء من تخزين الوصول إلى التطبيق، راجع **سجل التدقيق** لتحديد النطاق الكامل للخرق. ابحث عن المستخدمين المتأثرين، والأطر الزمنية التي كان للتطبيق غير المشروع حق الوصول إليها في مؤسستك، والأذونات التي يمتلكها التطبيق. يمكنك البحث في **سجل التدقيق** في [مدخل Microsoft 365 Defender](../../compliance/search-the-audit-log-in-security-and-compliance.md).

> [!IMPORTANT]
> يجب تمكين [تدقيق علبة البريد](../../compliance/enable-mailbox-auditing.md) [وتدقيق النشاط للمسؤولين والمستخدمين](../../compliance/turn-audit-log-search-on-or-off.md) قبل الهجوم للحصول على هذه المعلومات.

## <a name="how-to-stop-and-remediate-an-illicit-consent-grant-attack"></a>كيفية إيقاف هجوم منح الموافقة غير المشروعة ومعالجتها

بعد تحديد تطبيق بأذونات غير قانونية، لديك عدة طرق لإزالة هذا الوصول.

- يمكنك إبطال إذن التطبيق في مدخل Azure Active Directory عن طريق:
  1. انتقل إلى المستخدم المتأثر في جزء **مستخدم Azure Active Directory** .
  2. حدد **التطبيقات**.
  3. حدد التطبيق غير المشروع.
  4. انقر فوق **"إزالة** " في التنقل لأسفل.

- يمكنك إبطال منحة موافقة OAuth مع PowerShell باتباع الخطوات الواردة في [Remove-AzureADOAuth2PermissionGrant](/powershell/module/azuread/Remove-AzureADOAuth2PermissionGrant).

- يمكنك إبطال تعيين دور تطبيق الخدمة باستخدام PowerShell باتباع الخطوات الواردة في [Remove-AzureADServiceAppRoleAssignment](/powershell/module/azuread/Remove-AzureADServiceAppRoleAssignment).

- يمكنك أيضا تعطيل تسجيل الدخول للحساب المتأثر تماما، مما سيؤدي بدوره إلى تعطيل وصول التطبيق إلى البيانات في هذا الحساب. هذا ليس مثاليا لإنتاجية المستخدم النهائي، بالطبع، ولكن إذا كنت تعمل على الحد من التأثير بسرعة، فقد يكون ذلك معالجة قصيرة الأجل قابلة للتطبيق.

- يمكنك إيقاف تشغيل التطبيقات المتكاملة لاستئجارك. هذه خطوة جذرية تعطل قدرة المستخدمين النهائيين على منح الموافقة على نطاق المستأجر. يمنع هذا المستخدمين من منح الوصول إلى تطبيق ضار عن غير قصد. لا يوصى بذلك بشدة لأنه يؤثر سلبا على قدرة المستخدمين على أن يكونوا منتجين مع تطبيقات الجهات الخارجية. يمكنك القيام بذلك باتباع الخطوات في [تشغيل التطبيقات المتكاملة أو إيقاف تشغيلها](../../admin/misc/user-consent.md).

## <a name="secure-microsoft-365-like-a-cybersecurity-pro"></a>تأمين Microsoft 365 مثل محترف الأمان عبر الإنترنت

يأتي اشتراكك في Microsoft 365 مزودا بمجموعة قوية من قدرات الأمان التي يمكنك استخدامها لحماية بياناتك والمستخدمين. استخدم [مخطط أمان Microsoft 365 - أهم الأولويات لأول 30 يوما و90 يوما وما بعدها](security-roadmap.md) لتنفيذ أفضل الممارسات الموصى بها من Microsoft لتأمين مستأجر Microsoft 365.

- المهام المطلوب إنجازها في أول 30 يوما. لها تأثير فوري ولها تأثير منخفض على المستخدمين.
- المهام المطلوب إنجازها في غضون 90 يوما. يستغرق ذلك وقتا أطول قليلا للتخطيط والتنفيذ ولكن تحسين وضعك الأمني بشكل كبير.
- بعد 90 يوما. يتم إنشاء هذه التحسينات في أول 90 يوما من عملك.

## <a name="see-also"></a>راجع أيضًا

- [التطبيق غير المتوقع في قائمة التطبيقات الخاصة بي](/azure/active-directory/application-access-unexpected-application) يرشد المسؤولين من خلال إجراءات مختلفة قد يرغبون في اتخاذها بعد إدراك وجود تطبيقات غير متوقعة مع الوصول إلى البيانات.
- [دمج التطبيقات مع Azure Active Directory](/azure/active-directory/active-directory-apps-permissions-consent) هو نظرة عامة عالية المستوى للموافقة والأذونات.
- توفر [المشاكل المتعلقة بتطوير تطبيقي](/azure/active-directory/active-directory-application-dev-development-content-map) روابط لمختلف المقالات ذات الصلة بالموافقة.
- توفر [عناصر التطبيق والخدمة الأساسية في Azure Active Directory (Azure AD)](/azure/active-directory/develop/active-directory-application-objects) نظرة عامة على عناصر التطبيق والخدمة الأساسية التي تعتبر أساسية لنموذج التطبيق.
- [إدارة الوصول إلى التطبيقات](/azure/active-directory/active-directory-managing-access-to-apps) هي نظرة عامة على القدرات التي لدى المسؤولين لإدارة وصول المستخدم إلى التطبيقات.
