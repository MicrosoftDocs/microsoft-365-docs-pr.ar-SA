---
title: الكشف عن منح الموافقة غير المشروعة وتدريبها
f1.keywords:
- NOCSH
ms.author: tracyp
author: MSFTTracyp
manager: dansimp
ms.date: ''
audience: ITPro
ms.topic: article
ms.collection:
- o365_security_incident_response
- M365-security-compliance
ms.localizationpriority: medium
search.appverid:
- MET150
description: تعرف على كيفية التعرف على الموافقة غير المشروعة التي تمنح الهجمات في Microsoft 365.
ms.custom:
- seo-marvel-apr2020
ms.technology: mdo
ms.prod: m365-security
ms.openlocfilehash: db401231a2db0bddf1115cbdf14ae14cc9897f57
ms.sourcegitcommit: c6a97f2a5b7a41b74ec84f2f62fabfd65d8fd92a
ms.translationtype: MT
ms.contentlocale: ar-SA
ms.lasthandoff: 01/12/2022
ms.locfileid: "63567167"
---
# <a name="detect-and-remediate-illicit-consent-grants"></a>الكشف عن منح الموافقة غير المشروعة وتدريبها

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender-for-office.md)]

**ينطبق على**
- [Microsoft Defender Office 365 الخطة 1 الخطة 2](defender-for-office-365.md)
- [Microsoft 365 Defender](../defender/microsoft-365-defender.md)

**ملخص**  تعرف على كيفية التعرف على الموافقة غير المشروعة التي تمنح الهجمات في Microsoft 365.

## <a name="what-is-the-illicit-consent-grant-attack-in-microsoft-365"></a>ما هو هجوم منح الموافقة غير المشروعة في Microsoft 365؟

في هجوم منح الموافقة غير المشروعة، ينشئ المهاجم تطبيقا مسجلا في Azure يطلب الوصول إلى بيانات مثل معلومات جهة الاتصال أو البريد الإلكتروني أو المستندات. بعد ذلك، يخدع المهاجم المستخدم النهائي لمنح هذا التطبيق الموافقة على الوصول إلى بياناته إما من خلال هجوم تصيد احتيالي، أو عن طريق إدخال رمز غير موثوق به في موقع ويب موثوق به. بعد الحصول على موافقة التطبيق غير المشروع، تتوفر له إمكانية الوصول على مستوى الحساب إلى البيانات دون الحاجة إلى حساب المؤسسة. خطوات المعالجة العادية، مثل إعادة تعيين كلمات المرور للحسابات المخترقة أو المطالبة بمصادقة متعددة العوامل (MFA) على الحسابات، ليست فعالة ضد هذا النوع من الهجمات، نظرا لأن هذه التطبيقات هي تطبيقات جهات خارجية وخارج المؤسسة.

تستفيد هذه الهجمات من نموذج تفاعل يفترض أن الكيان الذي يتصل بالمعلومات هو التنفيذ التلقائي وليس الإنسان.

> [!IMPORTANT]
> هل تعتقد أنك تواجه مشاكل في منح الموافقة غير المشروعة من تطبيق، في الوقت الحالي؟ لدى Microsoft Defender for Cloud Apps أدوات للكشف عن تطبيقات OAuth الخاصة بك، والتحري عنها، وتدوينها. تعرض مقالة Defender for Cloud Apps هذه برنامج تعليمي يوضح كيفية العمل على التحقق من تطبيقات [OAuth المعرضة للمخاطر](/cloud-app-security/investigate-risky-oauth). يمكنك أيضا تعيين [سياسات تطبيق OAuth](/cloud-app-security/app-permission-policy) للتحقق من الأذونات المطلوبة من التطبيق، والتي يصادق عليها المستخدمون، والموافقة على طلبات الأذونات هذه أو حظرها على نطاق واسع.

## <a name="what-does-an-illicit-consent-grant-attack-look-like-in-microsoft-365"></a>كيف يبدو هجوم منح الموافقة غير المشروعة في Microsoft 365؟

تحتاج إلى البحث في سجل **التدقيق** للعثور على علامات، تسمى أيضا مؤشرات اختراق (IOC) لهذا الهجوم. بالنسبة إلى المؤسسات التي بها العديد من تطبيقات Azure المسجلة وقاعدة مستخدم كبيرة، فإن أفضل ممارسة هي مراجعة منح موافقة المؤسسات على أساس أسبوعي.

### <a name="steps-for-finding-signs-of-this-attack"></a>خطوات البحث عن علامات هذا الهجوم

1. افتح Microsoft 365 Defender في ثم <https://security.microsoft.com> حدد **تدقيق**. أو للانتقال مباشرة إلى صفحة **التدقيق**، استخدم <https://security.microsoft.com/auditlogsearch>.

2. في صفحة **التدقيق**، تحقق من تحديد علامة  التبويب بحث، ثم قم بتكوين الإعدادات التالية:
   - **نطاق التاريخ والوقت**
   - **الأنشطة**: **تحقق من تحديد** إظهار النتائج لكل الأنشطة.

   عند الانتهاء، انقر فوق **بحث**.

3. انقر فوق **العمود** نشاط لفرز النتائج وابحث عن **الموافقة على التطبيق**.

4. حدد إدخالا من القائمة لمشاهدة تفاصيل النشاط. تحقق لمعرفة ما إذا تم تعيين IsAdminContent إلى True.

> [!NOTE]
>
> قد يستغرق عرض إدخال سجل التدقيق المناظر في نتائج البحث بعد وقوع الحدث ما من 30 دقيقة إلى 24 ساعة.
>
> تعتمد المدة الزمنية التي يتم فيها الاحتفاظ بسجل تدقيق قابل للبحث فيه في سجل التدقيق على اشتراك Microsoft 365، وعلى نوع الترخيص المعين لمستخدم معين تحديدا. لمزيد من المعلومات، راجع [سجل التدقيق](../../compliance/search-the-audit-log-in-security-and-compliance.md).
>
> إذا كانت هذه القيمة صحيحة، فهي تشير إلى أن شخصا لديه حق وصول المسؤول العام قد يكون منح حق وصول واسع النطاق إلى البيانات. إذا كان هذا الأمر غير متوقع، فاتخذ خطوات [لتأكيد هجوم](#how-to-confirm-an-attack).

## <a name="how-to-confirm-an-attack"></a>كيفية تأكيد هجوم

إذا كان لديك مثيل واحد أو أكثر من أجهزة IOCs المذكورة أعلاه، يجب إجراء المزيد من التحقيق لتأكيد حدوث الهجوم بشكل إيجابي. يمكنك استخدام أي من هذه الأساليب الثلاثة لتأكيد الهجوم:

- تطبيقات المخزون والأذونات الخاصة بها باستخدام مدخل Azure Active Directory. هذه الطريقة شاملة، ولكن يمكنك التحقق من مستخدم واحد فقط في كل مرة والتي يمكن أن تستغرق وقتا طويلا جدا إذا كان لديك العديد من المستخدمين للتحقق منها.
- تطبيقات المخزون والأذونات الخاصة بها باستخدام PowerShell. هذا هو الأسلوب الأسرع والأكثر دقة، مع أقل قدر من النفقات العامة.
- يجب أن يقوم المستخدمون بالتحقق بشكل فردي من تطبيقاتهم وأذوناتهم ويعيدون تقرير النتائج إلى المسؤولين من أجل المعالجة.

## <a name="inventory-apps-with-access-in-your-organization"></a>تطبيقات المخزون التي لها حق الوصول في مؤسستك

يمكنك القيام بذلك للمستخدمين باستخدام مدخل Azure Active Directory أو PowerShell أو أن يقوم المستخدمون الخاصون بك تعداد الوصول إلى التطبيق بشكل فردي.

### <a name="steps-for-using-the-azure-active-directory-portal"></a>خطوات استخدام مدخل Azure Active Directory

يمكنك البحث عن التطبيقات التي منحها أي مستخدم فردي أذونات باستخدام مدخل Azure Active Directory في <https://portal.azure.com>.

1. سجل الدخول إلى مدخل Azure باستخدام الحقوق الإدارية.
2. حدد شفرة Azure Active Directory.
3. حدد **المستخدمون**.
4. حدد المستخدم الذي تريد مراجعته.
5. حدد **التطبيقات**.

سيعرض لك ذلك التطبيقات التي تم تعيينها للمستخدم والأذونات التي تملكها التطبيقات.

### <a name="steps-for-having-your-users-enumerate-their-application-access"></a>خطوات تسمح للمستخدمين الخاصين بك ب تعداد الوصول إلى التطبيقات الخاصة بهم

يجب على المستخدمين الانتقال إلى <https://myapps.microsoft.com> الوصول إلى التطبيق الخاص بهم ومراجعته هناك. وينبغي أن يتمكنوا من رؤية جميع التطبيقات التي تتمتع بالوصول، وعرض التفاصيل الخاصة بها (بما في ذلك نطاق الوصول)، وأن يتمكنوا من إبطال الامتيازات للتطبيقات المريبة أو غير المريبة.

### <a name="steps-for-doing-this-with-powershell"></a>خطوات للقيام بذلك باستخدام PowerShell

إن أبسط طريقة للتحقق من هجوم "منح الموافقة غير المشروعة [ " ](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09)هي تشغيلGet-AzureADPSPermissions.ps1، مما يعني تفريغ كل منح موافقة OAuth وتطبيقات OAuth لجميع المستخدمين في إيجارك في ملف .csv واحد.

#### <a name="pre-requisites"></a>المتطلبات الأساسية

- تم تثبيت مكتبة Azure AD PowerShell.
- حقوق المسؤول العام للمستأجر التي سيتم تشغيل البرنامج النصي مقابلها.
- المسؤول المحلي على الكمبيوتر الذي سيتم تشغيل البرامج النصية منه.

> [!IMPORTANT]
> نوصي ***بشدة*** بأن تحتاج إلى مصادقة متعددة العوامل على حسابك الإداري. يدعم هذا البرنامج النصي مصادقة المصادقة MFA.

1. سجل الدخول إلى الكمبيوتر الذي سيتم تشغيل البرنامج النصي منه باستخدام حقوق المسؤول المحلي.

2. قم بتنزيل البرنامج [Get-AzureADPSPermissions.ps1](https://gist.github.com/psignoret/41793f8c6211d2df5051d77ca3728c09) النصي من GitHub إلى مجلد سيتم تشغيل البرنامج النصي منه. سيكون هذا هو المجلد نفسه الذي سيتم كتابة ملف "permissions.csv" الإخراج فيه.

3. افتح جلسة PowerShell كمسؤول وافتح المجلد الذي حفظت البرنامج النصي فيه.

4. الاتصال إلى الدليل باستخدام الاتصال [cmdlet الاتصال AzureAD](/powershell/module/azuread/connect-azuread).

5. تشغيل الأمر PowerShell هذا:

   ```powershell
   .\Get-AzureADPSPermissions.ps1 | Export-csv -Path "Permissions.csv" -NoTypeInformation
   ```

ينتج البرنامج النصي ملفا واحدا يسمى Permissions.csv. اتبع هذه الخطوات للبحث عن منح أذونات التطبيق غير المشروعة:

1. في العمود ConsentType (العمود G) ابحث عن القيمة "AllPrinciples". يسمح إذن AllPrincipals لتطبيق العميل بالوصول إلى محتوى الجميع في إيجار. تحتاج Microsoft 365 الأصلية إلى هذا الإذن للعمل بشكل صحيح. يجب مراجعة كل تطبيق غير من تطبيقات Microsoft مع هذا الإذن بعناية.

2. في العمود إذن (العمود F) راجع الأذونات التي لدى كل تطبيق مفوض إلى المحتوى. ابحث عن إذن "قراءة" و"كتابة" أو "*. إذن "الكل"، وراجع هذه الأذونات بعناية لأنها قد لا تكون مناسبة.

3. راجع المستخدمين المحددين الذين تم منحهم الموافقة. إذا تم منح الموافقات غير المناسبة للمستخدمين الذين لديهم ملفات تعريف عالية المستوى أو المستخدمون الذين لديهم تأثير عال، يجب عليك إجراء المزيد من التحقيق.

4. في العمود ClientDisplayName (العمود C) ابحث عن التطبيقات التي تبدو مريبا. يجب مراجعة التطبيقات التي بها أسماء بها أخطاء إملائية أو أسماء عليا أو أسماء صوت المتسللين بعناية.

## <a name="determine-the-scope-of-the-attack"></a>تحديد نطاق الهجوم

بعد الانتهاء من جرد الوصول إلى التطبيق، راجع سجل **التدقيق** لتحديد النطاق الكامل للمخالفة. ابحث عن المستخدمين المتأثرين والإطارات الزمنية التي كان للتطبيق غير المشروع حق الوصول إليها في مؤسستك والأذونات المتوفرة للتطبيق. يمكنك البحث في **سجل التدقيق** في Microsoft 365 Defender [المدخل](../../compliance/search-the-audit-log-in-security-and-compliance.md).

> [!IMPORTANT]
> [يجب تمكين تدقيق علبة](../../compliance/enable-mailbox-auditing.md) البريد وتدقيق [النشاط](../../compliance/turn-audit-log-search-on-or-off.md) للمسؤولين والمستخدمين قبل الهجوم لكي تحصل على هذه المعلومات.

## <a name="how-to-stop-and-remediate-an-illicit-consent-grant-attack"></a>كيفية إيقاف هجوم منح الموافقة غير المشروعة وكيفية إصلاحه

بعد تحديد تطبيق له أذونات غير مهيئ، لديك عدة طرق لإزالة هذا الوصول.

- يمكنك إبطال إذن التطبيق في مدخل Azure Active Directory عن طريق:
  1. انتقل إلى المستخدم المتأثر في **شفرة مستخدم Azure Active Directory** .
  2. حدد **التطبيقات**.
  3. حدد التطبيق غير المشروع.
  4. انقر **فوق إزالة** في التنقل لأسفل.

- يمكنك إبطال منح موافقة OAuth مع PowerShell باتباع الخطوات في [Remove-AzureADOAuth2PermissionGrant](/powershell/module/azuread/Remove-AzureADOAuth2PermissionGrant).

- يمكنك إبطال تعيين دور تطبيق الخدمة باستخدام PowerShell باتباع الخطوات في [Remove-AzureADServiceAppRoleAssignment](/powershell/module/azuread/Remove-AzureADServiceAppRoleAssignment).

- يمكنك أيضا تعطيل تسجيل الدخول للحساب المتأثر تماما، مما سيؤدي بدوره إلى تعطيل وصول التطبيق إلى البيانات الموجودة في ذلك الحساب. لا يعد هذا الأمر مثاليا لزيادة إنتاجية المستخدم، بطبيعة الحال، ولكن إذا كنت تعمل على الحد من التأثير بسرعة، فقد يكون إصلاحا قصير الأمد قابلا للتطبيق.

- يمكنك إيقاف تشغيل التطبيقات المتكاملة لموئل إيجارك. هذه خطوة جذرية تعطل قدرة المستخدمين النهائيين على منح الموافقة على نطاق المستأجر. يمنع هذا المستخدمين من منح حق الوصول إلى تطبيق ضار عن غير قصد. هذا الأمر غير مستحسن بشدة حيث إنه يضعف قدرة المستخدمين بشدة على تحقيق الإنتاجية باستخدام تطبيقات  الأطراف الخارجية. يمكنك القيام بذلك باتباع الخطوات في [تشغيل التطبيقات المتكاملة أو إيقاف تشغيلها](../../admin/misc/user-consent.md).

## <a name="secure-microsoft-365-like-a-cybersecurity-pro"></a>تأمين Microsoft 365 مثل محترف الأمان عبر الإنترنت

يأتي Microsoft 365 الخاص بك مع مجموعة فعالة من إمكانات الأمان التي يمكنك استخدامها لحماية بياناتك والمستخدمين. استخدم Microsoft 365 الأمان - أهم الأولويات لأول [30 يوما أو 90](security-roadmap.md) يوما أو أكثر لتنفيذ أفضل الممارسات المستحسنة من Microsoft لتأمين Microsoft 365 المستأجر.

- المهام التي يجب إنجازها في أول 30 يوما. وهي تؤثر بشكل مباشر على المستخدمين وتنخفض تأثيرها على المستخدمين.
- المهام التي يجب إنجازها في غضون 90 يوما. يستغرق هذا الأمر وقتا أطول قليلا من أجل التخطيط له وتطبيقه، ولكنه يحسن وضع الأمان بشكل كبير.
- بعد 90 يوما. يتم إنشاء هذه التحسينات في أول 90 يوما من العمل.

## <a name="see-also"></a>راجع أيضًا

- [تطبيق غير متوقع في قائمة التطبيقات الخاصة](/azure/active-directory/application-access-unexpected-application) بى يرحل المسؤولون عبر مختلف الإجراءات التي قد يرغبون في اتخاذها بعد أن يدركوا أن هناك تطبيقات غير متوقعة مع إمكانية الوصول إلى البيانات.
- [يعد دمج التطبيقات مع Azure Active Directory](/azure/active-directory/active-directory-apps-permissions-consent) نظرة عامة عالية المستوى حول الموافقة والأذونات.
- [توفر المشاكل المتعلقة بتطوير التطبيق](/azure/active-directory/active-directory-application-dev-development-content-map) ارتباطات إلى مقالات مختلفة ذات صلة بالموافقة.
- توفر العناصر الأساسية للتطبيقات والخدمات في [Azure Active Directory (Azure AD)](/azure/active-directory/develop/active-directory-application-objects) نظرة عامة على العناصر الأساسية للتطبيق والخدمة التي تكون أساسية لنموذج التطبيق.
- [إدارة الوصول إلى التطبيقات](/azure/active-directory/active-directory-managing-access-to-apps) هي نظرة عامة على الإمكانات التي لدى المسؤولين لإدارة وصول المستخدمين إلى التطبيقات.
